# Контекст проекта: Bitrix24 Виджет карты для проработки новых абонентов с интеграцией с Userside (Nuxt 3)
## Описание проекта
Веб-приложение на Nuxt 3 с виджетом карты для Bitrix24, который интегрируется с системой Userside для планирования новых клмиентов и отображения существующих интернет-провайдера.
### Основные библиотеки
- **Nuxt 3 (v4.2.1)** - фреймворк для Vue.js приложений
- **Vue 3 (v3.5.25)** - прогрессивный JavaScript фреймворк
- **@bitrix24/b24jssdk (v0.5.1)** - официальный SDK для работы с Bitrix24 API
- **leaflet** - библиотека для отображения карт на веб-сайтах
- **leaflet-geoman** - библиотека для рисования геопримитивов на картах leaflet
- **MarkerCluster** - библиотека для группировки геопримитивов leaflet в кластеры
- **leaflet.contextmenu** - библиотека для отображения контекстного меню для геопримитивов leaflet
### Структура проекта
```
/project
├── nuxt.config.ts               - Конфигурация Nuxt
├── package.json                 - Зависимости и скрипты
├── app.vue                      - Корневой компонент приложения
├── .env                         - Переменные окружения
│
├── pages/
│   ├── index.vue                - Главная страница с навигацией
│   └── amap.vue                 - Карта (основной функционал)
│
├── composables/
│   ├── bitrix24.js              - Инициализация Bitrix24 SDK, работа с объектами и геопритивами хранящимися в Битрикс24
│   ├── us-api.js                - API клиент для userside для получения данных о объектах связи, линиях связи, оборудовании интернет-провайдера
│   ├── customers.js             - Работа данными о клиентах
│
├── assets/
│   └── css/
│       └── main.css             - Глобальные стили
│
└── .nuxt/                       - Сгенерированные файлы Nuxt (не коммитить)
```

### 1. Точки входа

#### `/amap` - Основная форма интеграции
- **Файл:** `pages/amap.vue`
- **Назначение:** Полнофункциональный виджет Bitrix24 для отображения географической карты и работы с ней
- **Технология:** Vue 3 SFC (Single File Component) в Nuxt 3
- **Зависимости:** Bitrix24 SDK, Leaflet, leaflet-geoman,  MarkerCluster, leaflet.contextmenu, Userside and Billing REST API, composables
  
### 2. Инициализация Bitrix24

**В amap.vue:**
```javascript
import { B24Frame } from '@bitrix24/b24jssdk'
// Инициализация
b24Instance = await B24Frame.initializeB24Frame()
```
**Важно:**
- Виджет работает как приложение Bitrix24 и использует данные приложения для авторизации и передает их строннему API дла авторицации себя как приложения  Bitrix24
- Используется локальная переменная `b24Instance` в amap.vue
- b24Instance передается в функции в bitrix24.js для работы с сущностями Битрикс24

### 3. Данные авторизации Bitrix24
**Получение auth данных:**
```javascript
function getB24AuthData() {
  const auth = b24Instance.auth.getAuthData()
  return {
    domain: auth.domain || '',
    member_id: auth.member_id || '',
    access_token: auth.access_token || '',
    refresh_token: auth.refresh_token || '',
    expires_in: auth.expires_in || 0
  }
}
```
**Формат всех POST запросов к стороннему API через ESB:**
```json
{
  "auth": {
    "domain": "company.bitrix24.ru",
    "member_id": "...",
    "access_token": "...",
    "refresh_token": "...",
    "expires_in": 3600
  },
<Параметры API endpoint>
}
```
### 4. Работа с геопримитивами в Bitrix24
Примитивы хранятся в смартпроцессе 139, примитивов два вида
полигоны - id 61, отображают зоны для проработки.
точки - id 65, отображают потенциальных клиентов.
Основные действия на карте - создать, изменить геометрию, удалить, открыть карточку элемента Битрикс24.

### 5. Объекты Userside на карте
На карту в отдельные слои выводятся объекты из системы описания сети связи - узлы и оптические линии.
